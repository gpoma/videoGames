var wordsToSay = [];

function addWord(data,majurl = false){
    var html = '<a class="btn btn-xs btn-default" onClick="removeWord($(this));" title="'+data.text+'" style="margin-right:5px; margin-top:5px;" ><strong><span class="text-muted" role="presentation">Ã—</span>&nbsp;'+data.text+'</strong></a>';
     wordsToSay.push(data);
     $("#footer > div > span").html($("#footer > div > span").html()+html);
     $("#select2").val(null).trigger("change");
     $("#select2").focus();

     if(majurl){
         rebuildUrlFromWords();
         changeVideo(pathGame,""+data.id, 'infini',false,1000,0);
     }
}

function removeWord(btn){
    var btn_index = $('#footer .text a').index(btn);
    if (btn_index !== -1) {
        wordsToSay.splice(btn_index, 1);
        btn.remove();
        rebuildUrlFromWords();
    }
}

function createWordFromUrl(){
    var url_string = window.location;
    var url = new URL(url_string);
    var oneOrMoreVideo = false;
    var texte = decodeURIComponent(url.searchParams.get("texte"));
    if(""+texte == "null"){
        var msg = url.searchParams.get("msg");
        if(msg){
            texte=atou(msg);
        }
    }
    if(""+texte != "null"){
        var texteArray = texte.split(',');
        var totalTextes = game_json.dictionnaire;
        for (var ti in texteArray) {
            var t = texteArray[ti];
            for (var x in totalTextes) {
                var o = totalTextes[x];
                if(o.word == t){
                    oneOrMoreVideo = true
                    addWord({text : t, id : o.id });
                    break;
                }
           }
        }
        if(oneOrMoreVideo){
            playSequenceBtn();
        }
    }
}

function rebuildUrlFromWords(){

    history.pushState("toto","str","?texte="+encodeURIComponent(createParamsUrl()));
    get_short_url();
}

function createParamsUrl(){
    var str = "";
    for (var x in wordsToSay) {
        str+=wordsToSay[x].text+",";
    }
    return str.slice(0, -1);
}

function get_short_url()
{
    console.log(window.location.host+window.location.pathname+"?msg="+utoa(createParamsUrl()));
}

// ucs-2 string to base64 encoded ascii
function utoa(str) {
    return window.btoa(unescape(encodeURIComponent(str)));
}

// base64 encoded ascii to ucs-2 string
function atou(str) {
    return decodeURIComponent(escape(window.atob(str)));
}

function playSequenceBtn(cpt = 0){
    var localCpt = 0;
    var videoElt = null;
    for (var x in wordsToSay) {
        if(localCpt == cpt){
            var videoId = wordsToSay[x].id;
            changeVideo(pathGame,videoId, 'infini',false,0,120,false);
            videoElt = document.getElementById( 'video_'+videoId );
            cpt++;
            break;
        }
        localCpt++;
    }
    if(videoElt){
        $(videoElt).bind('loadedmetadata', function() {
            var duration = videoElt.duration;
            var currentTime = videoElt.currentTime;
            var diff = (duration * 1000) - (currentTime * 1000);
            setTimeout(function(){
                    playSequenceBtn(cpt);
                    }, diff);
            $(videoElt).unbind('play');
            $(videoElt).unbind('loadedmetadata');
        });
    }else{
        for (var x in wordsToSay) {
            var videoIdToStop = wordsToSay[x].id;
            stopVideo(videoIdToStop);
        }

    }
}

var select2 = $('#select2').select2({
    allowClear: true,
    placeholder: "Tapez des mots",
}).on("select2:closing", function(e) {
e.preventDefault();
}).on("select2:closed", function(e) {
select2.select2("open");
});

select2.focus();

$('#select2').on('select2:select', function (e) {
  var data = e.params.data;
  var word = { "text" : data.text, "id" : data.id }
  addWord(word,true);

});

$('#select2').on('select2:close', function (e) {
  var select2SearchField = $(this).parent().find('.select2-search__field');
  var setfocus = setTimeout(function() {
      select2SearchField.focus();
  }, 100);
});

$(document).on('focus', '.select2.select2-container', function (e) {
  // only open on original attempt - close focus event should not fire open
  if (e.originalEvent && $(this).find(".select2-selection--single").length > 0) {
    $(this).siblings('select').select2('open');
  }
});
$('#select2').select2('open');    

createWordFromUrl();
